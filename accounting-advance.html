<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./responsive.css">
    <script src="https://kit.fontawesome.com/d3d61f5bb0.js" crossorigin="anonymous"></script>
    <title>USA Accounting - Advanced Course</title>
</head>

<body>
    <section class="form-container">
        <div class="form-box">
            <div class="heading-form">
                <h2>Please Fill Out All The Fields</h2>
            </div>
            <hr>
            <div class="form">
                <form id="enrollForm">
                    <!-- Personal Information -->
                    <div class="personal">
                        <h3>Personal Information</h3>
                        <label for="fullName">Full Name</label><br>
                        <input type="text" id="fullName" name="fullName" placeholder="Full Name" required><br>
                        <label for="emailAddress">E-Mail Address</label><br>
                        <input type="email" id="emailAddress" name="email" placeholder="E-Mail Address" required><br>
                        <label for="phoneNumber">Phone Number</label><br>
                        <input type="number" id="phoneNumber" name="phoneNumber" placeholder="Phone Number" required>
                    </div><br>
                    <!-- Course Information -->
                    <div class="course-related">
                        <h3>Course Information</h3> 
                        <label for="courseName">Course Name</label><br>
                        <input type="text" id="courseName" name="courseName"
                            value="US Accounting Mastery: Advanced Accounting Training" disabled><br>
                        <label for="coursePrice">Price</label><br>
                        <input type="text" id="coursePrice" name="coursePrice" value="14999" disabled>
                    </div>
                    <!-- Address Information -->
                    <div class="address-related">
                        <h3>Address Information</h3>
                        <label for="address">Address</label><br>
                        <input type="text" id="address" name="address" placeholder="Full Address" required><br>
                        <label for="city">City</label><br>
                        <input type="text" id="city" name="city" placeholder="City Name" required><br>
                        <label for="state">State</label><br>
                        <input type="text" id="state" name="state" placeholder="State Name" required><br>
                        <label for="country">Country</label><br>
                        <input type="text" id="country" name="country" placeholder="Country Name" required><br>
                    </div>
                    <!-- Additional Information -->
                    <div class="additional-related">
                        <h3>Additional Information</h3>
                        <label for="occupation">Occupation/Profession</label><br>
                        <input type="text" id="occupation" name="occupation" placeholder="Occupation/Profession"><br>
                        <label for="purpose">Purpose Of Enrollment</label><br>
                        <input type="text" id="purpose" name="purpose" placeholder="Purpose Of Enrollment"><br>
                        <label for="referral">Referral Source</label><br>
                        <input type="text" id="referral" name="referral" placeholder="From where you find us?"><br>
                    </div>
                    <div class="button-form">
                        <button type="button" id="checkoutBtn">Checkout Now&nbsp;&nbsp;<i
                                class="fa-regular fa-credit-card"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Firebase Compatibility Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="./FirebaseConfig/firebaseconfig.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        const razorpayKey = "rzp_test_1gkTjsmlul8v8V"; // Replace with your Razorpay Test Key

        firebase.auth().onAuthStateChanged(user => {
            if (!user) {
                window.location.href = 'register.html';
            } else {
                document.querySelector('#emailAddress').value = user.email;
            }
        });

        document.getElementById("checkoutBtn").onclick = async function () {
    const fullName = document.getElementById("fullName").value;
    const email = firebase.auth().currentUser.email;
    const phoneNumber = document.getElementById("phoneNumber").value;
    const courseName = "US Accounting Mastery: Advanced Accounting Training";

    if (!fullName || !email || !phoneNumber) {
        alert("Please fill in all required fields before proceeding.");
        return;
    }

    try {
        const db = firebase.firestore();

        // Check if the user is already enrolled in the same course
        const querySnapshot = await db
            .collection("enrolled_users")
            .where("email", "==", email)
            .where("courseName", "==", courseName)
            .get();

        if (!querySnapshot.empty) {
            alert("You are already enrolled in this course!");
            return; // Stop further processing
        }

        // Proceed with Razorpay payment initialization if the user is not already enrolled
        const options = {
            key: razorpayKey,
            amount: 14999 * 100, // Convert price to paise
            currency: "INR",
            name: "USA Accounting Course",
            description: courseName,
            image: "https://example.com/logo.png", // Replace with your logo
            handler: async function (response) {
                const paymentData = {
                    fullName,
                    email,
                    phoneNumber,
                    courseName,
                    coursePrice: "14999",
                    address: document.getElementById("address").value,
                    city: document.getElementById("city").value,
                    state: document.getElementById("state").value,
                    country: document.getElementById("country").value,
                    occupation: document.getElementById("occupation").value,
                    purpose: document.getElementById("purpose").value,
                    referralSource: document.getElementById("referral").value,
                    paymentId: response.razorpay_payment_id,
                    status: "paid"
                };

                try {
                    await db.collection("enrolled_users").add(paymentData);
                    alert("Payment successful! You have been enrolled in the course.");
                } catch (error) {
                    console.error("Error saving payment data:", error);
                    alert("Payment successful, but an error occurred while saving your data.");
                }
            },
            prefill: {
                name: fullName,
                email: email,
                contact: phoneNumber
            },
            theme: {
                color: "#3399cc"
            }
        };

        const rzp = new Razorpay(options);

        rzp.on("payment.failed", function (response) {
            alert("Payment failed! Reason: " + response.error.reason);
            console.error(response.error);
        });

        rzp.open();
    } catch (error) {
        console.error("Error checking enrollment:", error);
        alert("An error occurred while checking your enrollment status. Please try again.");
    }
};

    </script>
</body>

</html>
