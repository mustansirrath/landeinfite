<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./responsive.css">
    <script src="https://kit.fontawesome.com/d3d61f5bb0.js" crossorigin="anonymous"></script>
    <title>USA Accounting - Advanced Course</title>
</head>

<body>
    <section class="form-container">
        <div class="form-box">
            <div class="heading-form">
                <h2>Please Fill Out All The Fields</h2>
            </div>
            <hr>
            <div class="form">
                <form id="enrollForm">
                    <!-- Personal Information -->
                    <div class="personal">
                        <h3>Personal Information</h3>
                        <label for="fullName">Full Name</label><br>
                        <input type="text" id="fullName" name="fullName" placeholder="Full Name" required><br>
                        <label for="emailAddress">E-Mail Address</label><br>
                        <input type="email" id="emailAddress" name="email" placeholder="E-Mail Address" required><br>
                        <label for="phoneNumber">Phone Number</label><br>
                        <input type="number" id="phoneNumber" name="phoneNumber" placeholder="Phone Number" required>
                    </div><br>
                    <!-- Course Information -->
                    <div class="course-related">
                        <h3>Course Information</h3>
                        <label for="courseName">Course Name</label><br>
                        <input type="text" id="courseName" name="courseName" value="US Accounting Mastery: Advanced Accounting Training" disabled><br>
                        <label for="coursePrice">Price</label><br>
                        <input type="text" id="coursePrice" name="coursePrice" value="14999" disabled>
                    </div>
                    <!-- Address Information -->
                    <div class="address-related">
                        <h3>Address Information</h3>
                        <label for="address">Address</label><br>
                        <input type="text" id="address" name="address" placeholder="Full Address" required><br>
                        <label for="city">City</label><br>
                        <input type="text" id="city" name="city" placeholder="City Name" required><br>
                        <label for="state">State</label><br>
                        <input type="text" id="state" name="state" placeholder="State Name" required><br>
                        <label for="country">Country</label><br>
                        <input type="text" id="country" name="country" placeholder="Country Name" required><br>
                    </div>
                    <!-- Additional Information -->
                    <div class="additional-related">
                        <h3>Additional Information</h3>
                        <label for="occupation">Occupation/Profession</label><br>
                        <input type="text" id="occupation" name="occupation" placeholder="Occupation/Profession"><br>
                        <label for="purpose">Purpose Of Enrollment</label><br>
                        <input type="text" id="purpose" name="purpose" placeholder="Purpose Of Enrollment"><br>
                        <label for="referral">Referral Source</label><br>
                        <input type="text" id="referral" name="referral" placeholder="From where you find us?"><br>
                    </div>
                    <div class="button-form">
                        <button type="button" id="checkoutBtn">Checkout Now&nbsp;&nbsp;<i class="fa-regular fa-credit-card"></i></button>
                    </div>
                </form>
            </div>
        </div>
    </section>

    <!-- Firebase Compatibility Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <!-- Firebase Configuration -->
    <script src="./FirebaseConfig/firebaseconfig.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'register.html';
            } else {
                document.querySelector('#emailAddress').value = user.email;
            }
        });

        document.getElementById("checkoutBtn").onclick = async function () {
            const db = firebase.firestore();
            const user = firebase.auth().currentUser;

            if (!user) {
                alert("Please log in to proceed.");
                return;
            }

            const fullName = document.getElementById("fullName").value;
            const email = user.email;
            const phoneNumber = document.getElementById("phoneNumber").value;

            if (!fullName || !email || !phoneNumber) {
                alert("All fields are required.");
                return;
            }

            const courseName = "US Accounting Mastery: Advanced Accounting Training";
            const coursePrice = "14999";

            try {
                // Check if user already has an enrollment
                const existingEnrollmentQuery = await db.collection("enrollment_attempts")
                    .where("email", "==", email)
                    .where("courseName", "==", courseName)
                    .get();

                let enrollmentDocId = null;

                if (!existingEnrollmentQuery.empty) {
                    // Use existing enrollment
                    enrollmentDocId = existingEnrollmentQuery.docs[0].id;
                    await db.collection("enrollment_attempts").doc(enrollmentDocId).update({
                        status: "pending",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    // Create new enrollment
                    const newEnrollmentRef = await db.collection("enrollment_attempts").add({
                        fullName,
                        email,
                        phoneNumber,
                        courseName,
                        coursePrice,
                        status: "pending",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    enrollmentDocId = newEnrollmentRef.id;
                }

                // Retrieve Razorpay API key
                const configDoc = await db.collection("api_keys").doc("0BF03laooWXibHAwTeDM").get();
                const razorpayKey = configDoc.exists ? configDoc.data().razorpay_key : null;

                if (!razorpayKey) {
                    alert("Razorpay API key is missing. Contact support.");
                    return;
                }

                // Razorpay payment options
                const options = {
                    key: razorpayKey,
                    amount: coursePrice * 100, // in paise
                    currency: "INR",
                    name: "USA Accounting",
                    description: courseName,
                    handler: async function (response) {
                        try {
                            // Save payment immediately
                            await db.runTransaction(async (transaction) => {
                                const enrollmentRef = db.collection("enrollment_attempts").doc(enrollmentDocId);
                                transaction.update(enrollmentRef, {
                                    status: "paid",
                                    paymentId: response.razorpay_payment_id,
                                    paidAt: firebase.firestore.FieldValue.serverTimestamp()
                                });

                                // Move to enrolled_users collection
                                const enrollmentData = (await enrollmentRef.get()).data();
                                transaction.set(db.collection("enrolled_users").doc(enrollmentDocId), enrollmentData);
                            });

                            alert("Payment successful! You are now enrolled.");
                        } catch (error) {
                            console.error("Error processing payment:", error);
                            alert("Payment was successful, but there was an error processing your enrollment. Please contact support.");
                        }
                    },
                    prefill: {
                        name: fullName,
                        email: email,
                        contact: phoneNumber
                    },
                    theme: {
                        color: "#3399cc"
                    }
                };

                const rzp = new Razorpay(options);

                rzp.on("payment.failed", function (response) {
                    alert("Payment failed. Reason: " + response.error.reason);
                });

                rzp.open();
            } catch (error) {
                console.error("Error processing enrollment:", error);
                alert("An error occurred. Please try again.");
            }
        };
    </script>
</body>

</html>
